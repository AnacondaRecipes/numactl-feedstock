{% set version = "2.0.18" %}

package:
  name: libnuma-split
  version: {{ version }}

source:
  url: https://github.com/numactl/numactl/releases/download/v{{ version }}/numactl-{{ version }}.tar.gz
  sha256: b4fc0956317680579992d7815bc43d0538960dc73aa1dd8ca7e3806e30bc1274
  patches:
    # jakirkham found that these tests failed of aarch and ppc64le
    # https://github.com/conda-forge/numactl-feedstock/pull/1#issuecomment-1425000697
    # https://github.com/numactl/numactl/issues/163
    # https://github.com/numactl/numactl/issues/164
    - skip_failing_tests.patch  # [aarch64 or ppc64le]
    - fix_ppc64le_set_mempolicy_home_node.patch  # [ppc64le]

build:
  number: 0
  skip: true  # [not linux]

requirements:
  build:
    - {{ compiler('c') }}
    - {{ stdlib('c') }}
    - autoconf
    - automake
    - coreutils
    - libtool
    - make
    - sed

outputs:
  - name: libnuma
    script: install-libnuma.sh
    build:
      run_exports:
        - {{ pin_subpackage('libnuma', max_pin='x') }}
    requirements:
      build:
        - {{ compiler('c') }}
        - {{ stdlib('c') }}
        - autoconf
        - automake
        - coreutils
        - libtool
        - make
        - sed
    test:
      commands:
        - test -f $PREFIX/lib/libnuma.so
        - test ! -f $PREFIX/lib/libnuma.a
        - test -f $PREFIX/lib/pkgconfig/numa.pc
        - test -f $PREFIX/include/numa.h
        - test -f $PREFIX/include/numacompat1.h
        - test -f $PREFIX/include/numaif.h
        - test -f $PREFIX/lib/pkgconfig/numa.pc

  - name: numactl
    build:
      run_exports:
        - {{ pin_subpackage('libnuma', max_pin='x') }}
    script: install-numactl.sh
    requirements:
      build:
        - {{ compiler('c') }}
        - {{ stdlib('c') }}
        - autoconf
        - automake
        - coreutils
        - libtool
        - make
        - sed
      host:
        - libnuma {{ version.split('.')[0] }}
      run:
        - {{ pin_subpackage('libnuma', exact=True) }}
    test:
      commands:
        - numactl --show  # [not aarch64 and not ppc64le]
        - test -f $PREFIX/bin/memhog
        - test -f $PREFIX/bin/migratepages
        - test -f $PREFIX/bin/migspeed
        - test -f $PREFIX/bin/numactl
        - test -f $PREFIX/bin/numademo
        - test -f $PREFIX/bin/numastat
    about:
      license: GPL-2.0-only
      license_family: GPL
      license_file: LICENSE.GPL2

about:
  home: https://github.com/numactl/numactl
  summary: NUMA support for Linux
  description: |
    Simple NUMA policy support. It consists of a numactl program to run other
    programs with a specific NUMA policy and a libnuma shared library
    ("NUMA API") to set NUMA policy in applications.
  license: LGPL-2.1-only
  license_family: LGPL
  license_file: LICENSE.LGPL2.1
  dev_url: https://github.com/numactl/numactl
  doc_url: https://linux.die.net/man/8/numactl

extra:
  feedstock-name: numactl
  recipe-maintainers:
    - kkraus14
    - chrisburr
    - zklaus
